<!-- templates/judge/rate_members.html -->
{% extends "base.html" %}

{% block title %}评分 - {{ group.name }} - 评分系统{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="h4 mb-0">{{ group.name }} - 评分</h2>
                <p class="text-muted small mb-0">请为每位成员打分（0-100分）</p>
            </div>
            <a href="{{ url_for('select_group') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>返回选择
            </a>
        </div>
    </div>
</div>

<div class="mb-3">
    <div class="input-group">
        <span class="input-group-text">
            <i class="fas fa-search"></i>
        </span>
        <input type="text" 
               class="form-control" 
               id="memberSearch" 
               placeholder="搜索考号或姓名...">
    </div>
</div>

<div class="card">
    <div class="card-body">
        <form method="POST">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th>考号</th>
                            <th>姓名</th>
                            <th>学段</th>
                            <th>学科</th>
                            <th style="width: 200px;">分数</th>
                            <th>状态</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for member in members %}
                        {% set existing_score = member.scores|selectattr('judge_id', 'equalto', current_user.id)|first %}
                        <tr>
                            <td>{{ member.exam_number }}</td>
                            <td>{{ member.name }}</td>
                            <td>
                                <span class="badge bg-info">{{ member.school_stage }}</span>
                            </td>
                            <td>
                                <span class="badge bg-secondary">{{ member.subject }}</span>
                            </td>
                            <td>
                                {% if member.id in member_scores %}
                                <div class="input-group">
                                    <input type="number" 
                                           class="form-control text-center" 
                                           value="{{ member_scores[member.id] }}" 
                                           disabled>
                                    <span class="input-group-text">分</span>
                                </div>
                                {% else %}
                                <div class="input-group">
                                    <input type="number" 
                                           name="score_{{ member.id }}" 
                                           class="form-control text-center" 
                                           min="0" 
                                           max="100" 
                                           placeholder="0-100"
                                           required>
                                    <span class="input-group-text">分</span>
                                </div>
                                {% endif %}
                            </td>
                            <td>
                                {% if existing_score %}
                                <span class="badge bg-success">
                                    <i class="fas fa-check me-1"></i>已评分
                                </span>
                                {% else %}
                                <span class="badge bg-warning text-dark">
                                    <i class="fas fa-clock me-1"></i>待评分
                                </span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="d-flex justify-content-center mt-4">
                <button type="submit" class="btn btn-primary btn-lg px-5">
                    <i class="fas fa-save me-2"></i>提交评分
                </button>
            </div>
        </form>
    </div>
</div>

<div class="card mt-4">
    <div class="card-body">
        <h6 class="card-title">评分进度</h6>
        {% set total = current_user.total_to_score %}
        {% set scored = current_user.scored_count %}
        {% set percentage = (scored / total * 100)|round if total > 0 else 0 %}
        <div class="progress mb-2">
            <div class="progress-bar" 
                 role="progressbar" 
                 style="width: {{ percentage }}%"
                 aria-valuenow="{{ percentage }}" 
                 aria-valuemin="0" 
                 aria-valuemax="100">
                {{ percentage }}%
            </div>
        </div>
        <div class="small text-muted text-center">
            已评分 {{ scored }}/{{ total }} 人
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
// 搜索功能
document.getElementById('memberSearch').addEventListener('input', function(e) {
    const searchText = e.target.value.toLowerCase();
    document.querySelectorAll('tbody tr').forEach(row => {
        const examNumber = row.cells[0].textContent.toLowerCase();
        const name = row.cells[1].textContent.toLowerCase();
        row.style.display = 
            examNumber.includes(searchText) || name.includes(searchText) 
            ? '' 
            : 'none';
    });
});

// 自动保存草稿
const inputs = document.querySelectorAll('input[type="number"]');
inputs.forEach(input => {
    input.addEventListener('change', function() {
        localStorage.setItem(input.name, input.value);
    });
    
    // 恢复草稿
    const savedValue = localStorage.getItem(input.name);
    if (savedValue) {
        input.value = savedValue;
    }
});

// 提交时清除草稿
document.querySelector('form').addEventListener('submit', function() {
    inputs.forEach(input => {
        localStorage.removeItem(input.name);
    });
});

// 数字输入验证
inputs.forEach(input => {
    input.addEventListener('input', function() {
        let value = parseInt(this.value);
        if (isNaN(value)) {
            this.value = '';
        } else {
            if (value < 0) this.value = 0;
            if (value > 100) this.value = 100;
        }
    });
});
</script>
{% endblock %}